# 

**URL**:
https://github.langchain.ac.cn/langgraph/how-tos/persistence_postgres/

## 元数据
- 发布日期: 2026-02-20T20:40:06.961641

## 完整内容
---
如何使用 Postgres checkpointer 进行持久化- LangChain 教程[跳到主要内容] 
**加入我们参加[Interrupt: The Agent AI Conference by LangChain] ，时间是 5 月13 日和14 日在旧金山！**
[] # 如何使用Postgres checkpointer 进行持久化[¶] 
前提条件本指南假设您熟悉以下内容* [持久化] 
* [Postgresql] 
LangGraph API 用户不需要如果您正在使用LangGraph API，则无需手动实现 checkpointer。API 会自动为您处理checkpointing。本指南适用于您在自己的自定义服务器中实现 LangGraph 的情况。在创建LangGraph agent 时，您还可以对其进行设置，使其能够持久化其状态。这允许您执行诸如多次与agent 交互并让其记住先前的交互之类的操作。本操作指南展示了如何使用[`langgraph-checkpoint-postgres`] 库，将`Postgres`作为后端来持久化 checkpoint 状态。为了演示目的，我们向[预构建的 create react agent] 添加持久化功能。
通常，您可以像这样向构建的任何自定义图中添加checkpointer
```
`[]<web_link>fromlanggraph.graphimportStateGraph[]<web_link>[]<web_link>builder=StateGraph(....)[]<web_link># ... define the graph[]<web_link>checkpointer=# postgres checkpointer (see examples below)[]<web_link>graph=builder.compile(checkpointer=checkpointer)[]<web_link>...`
```
设置您需要在使用checkpointer 之前在其上运行一次`.setup()`来初始化数据库。
## 设置[¶] 
您将需要访问一个postgres 实例。网上有很多资源可以帮助您设置postgres 实例。接下来，让我们安装所需的软件包并设置API 密钥```
`[] pipinstall-Upsycopgpsycopg-poollanggraphlanggraph-checkpoint-postgres`
```
```
`[] importgetpass[] importos[] [] [] def\_set\_env(var:str):[] ifnotos.environ.get(var):[] os.environ[var]=getpass.getpass(f"{var}: ")[] [] [] \_set\_env("OPENAI\_API\_KEY")`
```
为LangGraph 开发设置[LangSmith]<web_link>
注册LangSmith，快速发现问题并提升 LangGraph 项目的性能。LangSmith 允许您使用跟踪数据来调试、测试和监控使用LangGraph 构建的LLM 应用程序——在此处[阅读更多关于如何入门的信息]<web_link>。
## 为图定义模型和工具[¶]<web_link>
API 参考：[tool]<web_link>|[ChatOpenAI]<web_link>|[create\_react\_agent]<web_link>|[PostgresSaver]<web_link>|[AsyncPostgresSaver]<web_link>
```
`[] fromtypingimportLiteral[] [] fromlangchain\_core.toolsimporttool[] fromlangchain\_openaiimportChatOpenAI[] fromlanggraph.prebuiltimportcreate\_react\_agent[] fromlanggraph.checkpoint.postgresimportPostgresSaver[] fromlanggraph.checkpoint.postgres.aioimportAsyncPostgresSaver[] [] [] @tool[] defget\_weather(city:Literal["nyc","sf"]):[] """Use this to get weather information."""[] ifcity=="nyc":[] return"It might be cloudy in nyc"[] elifcity=="sf":[] return"It's always sunny in sf"[] else:[] raiseAssertionError("Unknown city")[] [] [] tools=[get\_weather][] model=ChatOpenAI(model\_name="gpt-4o-mini",temperature=0)`
```
## 使用同步连接[¶]<web_link>
这将设置一个到数据库的同步连接。同步连接以阻塞方式执行操作，这意味着每个操作都会等待完成，然后才进行下一个操作。`DB\_URI`是数据库连接 URI，包含连接 PostgreSQL 数据库使用的协议、身份验证以及数据库运行的主机。connection\_kwargs 字典定义了数据库连接的附加参数。```
`[]<web_link>DB\_URI="postgresql://postgres:postgres@localhost:5442/postgres?sslmode=disable"`
```
```
`[]<web_link>connection\_kwargs={[]<web_link>"autocommit":True,[]<web_link>"prepare\_threshold":0,[]<web_link>}`
```
### 使用连接池[¶] 
这管理着一个可重用数据库连接池：- 优点：高效利用资源，提高频繁连接的性能- 适用于：具有许多短暂数据库操作的应用程序```
`[] frompsycopg\_poolimportConnectionPool[] [] withConnectionPool([] # Example configuration[] conninfo=DB\_URI,[] max\_size=20,[] kwargs=connection\_kwargs,[])aspool:[] checkpointer=PostgresSaver(pool)[] [] # NOTE: you need to call .setup() the first time you're using your checkpointer[] checkpointer.setup()[] [] graph=create\_react\_agent(model,tools=tools,checkpointer=checkpointer)[] config={"configurable":{"thread\_id":"1"}}[] res=graph.invoke({"messages":[("human","what's the weather in sf")]},config)[] checkpoint=checkpointer.get(config)`
```
```
`[] res`
```
```
`[] {'messages': [HumanMessage(content="what's the weather in sf", id='735b7deb-b0fe-4ad5-8920-2a3c69bbe9f7'),[] AIMessage(content='', additional\_kwargs={'tool\_calls': [{'id': 'call\_lJHMDYgfgRdiEAGfFsEhqqKV', 'function': {'arguments': '{"city":"sf"}', 'name': 'get\_weather'}, 'type': 'function'}]}, response\_metadata={'token\_usage': {'completion\_tokens': 14, 'prompt\_tokens': 57, 'total\_tokens': 71}, 'model\_name': 'gpt-4o-mini-2024-07-18', 'system\_fingerprint': 'fp\_48196bc67a', 'finish\_reason': 'tool\_calls', 'logprobs': None}, id='run-c56b3e04-08a9-4a59-b3f5-ee52d0ef0656-0', tool\_calls=[{'name': 'get\_weather', 'args': {'city': 'sf'}, 'id': 'call\_lJHMDYgfgRdiEAGfFsEhqqKV', 'type': 'tool\_call'}], usage\_metadata={'input\_tokens': 57, 'output\_tokens': 14, 'total\_tokens': 71}),[] ToolMessage(content="It's always sunny in sf", name='get\_weather', id='0644bf7b-4d1b-4ebe-afa1-d2169ccce582', tool\_call\_id='call\_lJHMDYgfgRdiEAGfFsEhqqKV'),[] AIMessage(content='The weather in San Francisco is always sunny!', response\_metadata={'token\_usage': {'completion\_tokens': 10, 'prompt\_tokens': 84, 'total\_tokens': 94}, 'model\_name': 'gpt-4o-mini-2024-07-18', 'system\_fingerprint': 'fp\_48196bc67a', 'finish\_reason': 'stop', 'logprobs': None}, id='run-1ed9b8d0-9b50-4b87-b3a2-9860f51e9fd1-0', usage\_metadata={'input\_tokens': 84, 'output\_tokens': 10, 'total\_tokens': 94})]}`
```
```
`[] checkpoint`
```
```
`[] {'v': 1,[] 'id': '1ef559b7-3b19-6ce8-8003-18d0f60634be',[] 'ts': '2024-08-08T15:32:42.108605+00:00',[] 'current\_tasks': {},[] 'pending\_sends': [],[] 'versions\_seen': {'agent': {'tools': '00000000000000000000000000000004.022986cd20ae85c77ea298a383f69ba8',[] 'start:agent': '00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc'},[] 'tools': {'branch:agent:should\_continue:tools': '00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af'},[] '\_\_input\_\_': {},[] '\_\_start\_\_': {'\_\_start\_\_': '00000000000000000000000000000001.ab89befb52cc0e91e106ef7f500ea033'}},[] 'channel\_versions': {'agent': '00000000000000000000000000000005.065d90dd7f7cd091f0233855210bb2af',[] 'tools': '00000000000000000000000000000005.',[] 'messages': '00000000000000000000000000000005.b9adc75836c78af94af1d6811340dd13',[] '\_\_start\_\_': '00000000000000000000000000000002.',[] 'start:agent': '00000000000000000000000000000003.',[] 'branch:agent:should\_continue:tools': '00000000000000000000000000000004.'},[] 'channel\_values': {'agent': 'agent',[] 'messages': [HumanMessage(content="what's the weather in sf", id='735b7deb-b0fe-4ad5-8920-2a3c69bbe9f7'),[] AIMessage(content='', additional\_kwargs={'tool\_calls': [{'id': 'call\_lJHMDYgfgRdiEAGfFsEhqqKV', 'function': {'arguments': '{"city":"sf"}', 'name': 'get\_weather'}, 'type': 'function'}]}, response\_metadata={'token\_usage': {'completion\_tokens': 14, 'prompt\_tokens': 57, 'total\_tokens': 71}, 'model\_name': 'gpt-4o-mini-2024-07-18', 'system\_fingerprint': 'fp\_48196bc67a', 'finish\_reason': 'tool\_calls', 'logprobs': None}, id='run-c56b3e04-08a9-4a59-b3f5-ee52d0ef0656-0', tool\_calls=[{'name': 'get\_weather', 'args': {'city': 'sf'}, 'id': 'call\_lJHMDYgfgRdiEAGfFsEhqqKV', 'type': 'tool\_call'}], usage\_metadata={'input\_tokens': 57, 'output\_tokens': 14, 'total\_tokens': 71}),[] ToolMessage(content="It's always sunny in sf", name='get\_weather', id='0644bf7b-4d1b-4ebe-afa1-d2169ccce582', tool\_call\_id='call\_lJHMDYgfgRdiEAGfFsEhqqKV'),[] AIMessage(content='The weather in San Francisco is always sunny!', response\_metadata={'token\_usage': {'completion\_tokens': 10, 'prompt\_tokens': 84, 'total\_tokens': 94}, 'model\_name': 'gpt-4o-mini-2024-07-18', 'system\_fingerprint': 'fp\_48196bc67a', 'finish\_reason': 'stop', 'logprobs': None}, id='run-1ed9b8d0-9b50-4b87-b3a2-9860f51e9fd1-0', usage\_metadata={'input\_tokens': 84, 'output\_tokens': 10, 'total\_tokens': 94})]}}`
```
### 使用单个连接[¶]<web_link>
这创建了一个到数据库的单个专用连接：- 优点：使用简单，适用于较长的事务- 适用于：具有较少、较长数据库操作的应用程序```
`[]<web_link>frompsycopgimportConnection[]<web_link>[]<web_link>[]<web_link>withConnection.connect(DB\_URI,\*\*connection\_kwargs)asconn:[]<web_link>checkpointer=PostgresSaver(conn)[]<web_link># NOTE: you need to call .setup() the first time you're using your checkpointer[]<web_link># checkpointer.setup()[]<web_link>graph=create\_react\_agent(model,tools=tools,checkpointer=checkpointer)[]<web_link>config={"configurable":{"thread\_id":"2"}}[]<web_link>res=graph.invoke({"messages":[("human","what's the weather in sf")]},config)[]<web_link>[]<web_link>checkpoint\_tuple=checkpointer.get\_tuple(config)`
```
```
`[]<web_link>checkpoint\_tuple`
```
```
`[]<web_link>CheckpointTuple(config={'configurable': {'thread\_id': '2', 'checkpoint\_ns': '', 'checkpoint\_id': '1ef559b7-4650-6bfc-8003-1c5488f19318'}}, checkpoint={'v': 1, 'id': '1ef559b7-4650-6bfc-8003-1c5488f19318', 'ts': '2024-08-08T15:32:43.284551+00:00', 'current\_tasks': {}, 'pending\_sends': [], 'versions\_seen': {'agent': {'tools': '00000000000000000000000000000004.022986cd20ae85c77ea298a383f69ba8', 'start:agent': '00000000000000000000000000000002.d6f25946c3108fc12f27abbcf9b4cedc'}, 'tools': {'branch:agent:should\_continue:tools': '00000000000000000000000000000003.065d90dd7f7cd091f0233855210bb2af'}, '\_\_input\_\_': {}, '\_\_start\_\_': {'\_\_start\_\_': '00000000000000000000000000000001.ab89befb52cc0e91e106ef7f500ea033'}}, 'channel\_versions': {'agent': '00000000000000000000000000000005.065d90dd7f7cd091f0233855210bb2af', 'tools': '00000000000000000000000000000005.', 'messages': '00000000000000000000000000000005.af9f229d2c4e14f4866eb37f72ec39f6', '\_\_start\_\_': '00000000000000000000000000000002.', 'start:agent': '00000000000000000000000000000003.', 'branch:agent:should\_continue:tools': '00000000000000000000000000000004.'}, 'channel\_values': {'agent': 'agent', 'messages': [HumanMessage(content="what's the weather in sf", id='7a14f96c-2d88-454f-9520-0e0287a4abbb'), AIMessage(content='


---
*数据来源: Exa搜索 | 获取时间: 2026-02-20 20:40:47*